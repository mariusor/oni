# Oni

Is a single user ActivityPub server compatible with Mastodon and the rest of the Fediverse.

It is part of the tools built for and with the help with of the [GoActivityPub](https://github.com/go-ap) library.

## Getting the source

```sh
$ git clone https://git.sr.ht/~mariusor/oni
$ cd oni
```

## Features

Posting to an ONI instance is done using Client to Server ActivityPub. 
Currently, the client that supports most features is [BOX](https://git.sr.ht/~mariusor/box).

The application supports text posts, image, audio and video uploads.

## Compiling

```sh
# We need to download the JavaScript dependencies, using yarn or npm:
# yarn install
# npm install
# Also, while we are in heavy development, we do have the 'go.sum' module checksum file in the repository,
# so we need to created it:
$ go mod tidy
# As a last step we need to bundle the static assets, for which we use go:generate with the 'esbuilder' API:
$ go generate assets.go
# We now can build the ONI and control helper binaries:
$ go build -trimpath -a -ldflags '-s -w -extldflags "-static"' -o $(go env GOPATH)/bin/oni ./cmd/oni/main.go
$ go build -trimpath -a -ldflags '-s -w -extldflags "-static"' -o $(go env GOPATH)/bin/onictl ./cmd/ctl/main.go
# All of these steps have been grouped together with Make:
$ make all
```

## Run server

```sh
# --listen can be a tcp socket, a domain socket, or the magic string "systemd"
# The later should be used if running as a systemd service with socket activation
$ oni --listen 127.0.4.2:4567 --path ~/.cache/oni 
```

## Add root actor 

```sh
# Creates an actor for URL https://johndoe.example.com and adds an OAuth2 client application with name 'johndoe.example.com'
# with OAuth2 client password 'SuperSecretOAuth2ClientPassword'. 
# The --with-token boolean flag can make the application generate an Authorization header containing a Bearer token 
# usable directly in an ActivityPub client.
$ onictl actor add --pw SuperSecretOAuth2ClientPassword https://johndoe.example.com
# with box
```

## Block remote instances

```sh
# Blocks all access to all johndoe.example.com pages for any access that has requests with Authorization 
# headers generated for actors hosted on naughty.social
$ onictl block --client https://johndoe.example.com https://naughty.social
```

## Interacting with ONI instances using BOX cli helper

### Documentation

Further reading on how to use ONI can be found on
the [SourceHut wiki](https://man.sr.ht/~mariusor/go-activitypub/oni/index.md).

The wiki also contains [more examples](https://man.sr.ht/~mariusor/go-activitypub/oni/box-cli-examples.md) than the ones
detailed here about how to use BOX for managing an ONI instance.

### Authorization

```sh
$ box authorize --as https://johndoe.example.com --secret SuperSecretOAuth2ClientPassword 
```

### Post a Note

```sh
# Here --id, --name and --content are optional
# --id gets generated by the server if missing
# If --name and --content are empty $EDITOR is opened and they get extracted from the result
# if the content contains two empty lines, the --name is the text that precedes them, 
# and the --content the text after
$ box post --as https://johndoe.example.com --id https://johndoe.example.com/posts/first \
--name "First Post" --content "This is a short post!"
```

### Upload an image

```sh
$ box upload --as https://johndoe.example.com --id https://johndoe.example.com/uploads/funny \
--name "Funny image" --summary "This is a short description." --path SOME/PATH/funny.jpg
```

### Blocking an Actor/Instance

```sh
$ box block --as https://johndoe.example.com --reason "Naughty, naughty!" https://naughty.social
```

## Contact and feedback

If you have problems, questions, ideas or suggestions, please contact us by posting to
the [discussions mailing list](https://lists.sr.ht/~mariusor/go-activitypub-discuss), or
on [GitHub](https://github.com/mariusor/oni/issues).
For quicker feedback the mailing list is preferred, as the GitHub issues are not checked very often.
